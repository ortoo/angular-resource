'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

exports['default'] = function () {

  // The length of time since an object has been requested that we keep in persistent storage.
  // In milliseconds - default to 7 days
  var pStorageMaxLen = 7 * 24 * 60 * 60 * 1000;

  // set pStorageMaxLen. In DAYS
  this.setPStorageMaxLen = function setPStorageMaxLen(len) {
    pStorageMaxLen = len * 24 * 60 * 60 * 1000;
  };

  this.$get = ResourceFactoryFactory;

  function ResourceFactoryFactory($window, $q, $rootScope, $timeout, $localForage, LocalResourceFactory, Chain, Collection) {
    'ngInject';

    function ResourceFactory(url, rootKey, rootKeyPlural) {
      rootKeyPlural = rootKeyPlural || rootKey + 's';

      // Create the local resource
      var LocalResource = LocalResourceFactory(url, rootKey, rootKeyPlural);

      // In memory resource store
      var _resources = {};
      var _resFromLocal = {};

      // Create an event emitter
      var emitter = new _events2['default'].EventEmitter();

      // Load from persistent storage (if we have something more exciting than localstorage)
      if (_utils2['default'].advancedStorage($localForage)) {
        var pStorageKey = _utils2['default'].persistentStorageKey(url);
        $localForage.getItem(pStorageKey).then(function (data) {
          if (!data) {
            return;
          }

          var now = new Date().getTime();

          data.forEach(function (datum) {
            var obj = datum.obj;
            var lastRequested = datum.lastreq;

            // Only create if the time between now and the last request is less than
            // pStorageMaxLen
            if (now - lastRequested <= pStorageMaxLen) {
              createFromStorage(obj, lastRequested);
            }
          });
        });
      }

      function localToRes(loc, id) {
        var res = _resFromLocal[loc.$id];

        // If we don't have a resource then create it
        if (!res) {
          res = new Resource(loc, true);
        }

        if (id) {
          _resources[id] = res;
        }

        return res;
      }

      function toObject() {
        return _utils2['default'].toObject(this);
      }

      function reset() {

        // If we aren't saved at all then just remove
        if (!this.$created) {
          this.$remove(true);
          return;
        }

        var newValues = this.$loc.$toObject();
        _utils2['default'].removeResValues(this);
        _utils2['default'].setResValues(this, newValues);
      }

      // The promise resolves once the save has been committed
      function save() {
        var res = this;
        res.$created = true;
        return this.$loc.$save(this.$toObject()).then(function () {
          if (!res.$resolved) {
            res.$deferred.resolve(res);
            res.$resolved = true;
          }
          return res;
        });
      }

      function remove(noPrompt, skipLocal) {
        if (!noPrompt) {
          // Add confirmation alert
          if (!$window.confirm('Do you really want to delete this item?')) {
            return;
          }
        }
        this.$deleted = true;
        if (this._id) {
          delete _resources[this._id];
        }

        var prom;
        if (skipLocal) {
          prom = $q.when(true);
        } else {
          prom = this.$loc.$remove();
        }

        emitter.emit('remove', this);

        return prom;
      }

      function type() {
        return rootKey[0].toUpperCase() + rootKey.slice(1);
      }

      function collection(seeds, relation) {
        return Collection(Resource, seeds, relation);
      }

      function chain(origQry, Model, qryFn) {
        return Chain(origQry, Model, qryFn);
      }

      function query(qry, limit) {
        var result = LocalResource.query(qry, limit, Resource);
        emitter.emit('query', result, qry, limit);
        return result;
      }

      function get(ids, force) {
        var results = LocalResource.get(ids, force, localToRes);
        emitter.emit('get', ids, results, force);
        return results;
      }

      function updatedLocal(res, newVal, oldVal) {

        // We could have been deleted (existing oldVal, null newval)
        if (oldVal && !newVal) {
          // We have been deleted. Cleanup ourselves
          res.$remove(true, true);
        } else {

          res.$created = true;

          if (oldVal._id && newVal._id !== oldVal._id) {
            throw new Error('Not allowed to change id');
          }

          // Merge the objects together using the oldVal as a base, and using *our* version
          // to resolve any conflicts. We may need to put in some conflict resolution logic
          // somewhere on a case by case basis
          var merge = _utils2['default'].mergeObjects(res.$toObject(), oldVal, newVal);

          // Now put back in the merge values
          _utils2['default'].removeResValues(res);
          _utils2['default'].setResValues(res, merge);

          // Make sure we are stored
          _resources[res._id] = res;
        }
      }

      function updateServer(val) {
        this.$loc.$updateServer(val);
      }

      // updates or creates a model depending on whether we know about it already. This
      // is usually used when we recieve a response with model data from the server using
      // a non-standard method
      function updateOrCreate(val) {
        var res = _resources[val._id];
        if (!res) {
          res = new Resource(val, false, new Date().getTime());
        } else {
          res.$updateServer(val);
        }

        return res;
      }

      function createFromStorage(val, lastRequested) {
        var res = _resources[val._id];

        // If we do have already know about a resource then lets assume it is more up to date
        // than the storage version. If we haven't resolved yet though (or we don't yet have
        // an ID on the object) lets update our values
        if (!res) {
          res = new Resource(val, false, lastRequested);
        } else if (!res._id || !res.$resolved) {
          res.$updateServer(val);
        }

        return res;
      }

      function refresh() {
        this.$loc.$refresh();
      }

      function Resource(val, fromLoc, lastRequested) {
        var res = this;
        this.$deleted = false;
        this.$deferred = $q.defer();
        this.$promise = this.$deferred.promise; // An initial promise for our initial
        // fetch or create of data
        this.$resolved = false; // Have we had an initial resolution of the promise
        this.$created = false; // Goes true on an initial save

        // If we've been given values put them on
        if (val) {
          var props = fromLoc ? val.$toObject() : val;
          for (var key in props) {
            res[key] = props[key];
          }
        }

        // Create the local resource
        if (fromLoc) {
          this.$loc = val;
          this.$loc.$mod = this;

          // Resolve the promise once the local copy has resolved
          this.$loc.$promise.then(function () {
            if (!res.$resolved) {
              res.$deferred.resolve(res);
              res.$resolved = true;
            }
          });
        } else if (this._id) {
          // We have an id - so we persist down
          this.$loc = new LocalResource(val, false, this, lastRequested);

          // We immediately resolve our promise since we have data
          this.$deferred.resolve(this);
          this.$resolved = true;
        } else {
          // Don't add in the values until we save
          this.$loc = new LocalResource(null, false, this);
        }

        this.$id = this.$loc.$id;
        _resFromLocal[this.$id] = this;

        // If we have an id then add us to the store
        if (this._id) {
          _resources[this._id] = this;
        }

        // Listen for changes on the local resource
        this.$loc.$emitter.on('update', function (newVal, oldVal) {
          updatedLocal(res, newVal, oldVal);
        });
      }

      Resource.get = get;
      Resource.query = query;
      Resource.chain = chain;
      Resource.type = type;
      Resource.collect = collection;
      Resource.updateOrCreate = updateOrCreate;

      // Event emitter 'inheritance'
      var eeprops = ['addListener', 'on', 'once', 'removeListener'];
      eeprops.forEach(function (prop) {
        Resource[prop] = function () {
          return emitter[prop].apply(emitter, arguments);
        };
      });

      Resource.prototype.$save = save;
      Resource.prototype.$remove = remove;
      Resource.prototype.$delete = remove;
      Resource.prototype.$type = type;
      Resource.prototype.$reset = reset;
      Resource.prototype.$refresh = refresh;
      Resource.prototype.$toObject = toObject;
      Resource.prototype.$updateServer = updateServer;

      return Resource;
    }

    ResourceFactory.Chain = Chain;

    return ResourceFactory;
  }
};

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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eEI7Q0FDRiIsImZpbGUiOiJtb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB1dGlscyBmcm9tICcuL3V0aWxzJztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oKSB7XG5cbiAgLy8gVGhlIGxlbmd0aCBvZiB0aW1lIHNpbmNlIGFuIG9iamVjdCBoYXMgYmVlbiByZXF1ZXN0ZWQgdGhhdCB3ZSBrZWVwIGluIHBlcnNpc3RlbnQgc3RvcmFnZS5cbiAgLy8gSW4gbWlsbGlzZWNvbmRzIC0gZGVmYXVsdCB0byA3IGRheXNcbiAgdmFyIHBTdG9yYWdlTWF4TGVuID0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDA7XG5cbiAgLy8gc2V0IHBTdG9yYWdlTWF4TGVuLiBJbiBEQVlTXG4gIHRoaXMuc2V0UFN0b3JhZ2VNYXhMZW4gPSBmdW5jdGlvbiBzZXRQU3RvcmFnZU1heExlbihsZW4pIHtcbiAgICBwU3RvcmFnZU1heExlbiA9IGxlbiAqIDI0ICogNjAgKiA2MCAqIDEwMDA7XG4gIH07XG5cbiAgdGhpcy4kZ2V0ID0gUmVzb3VyY2VGYWN0b3J5RmFjdG9yeTtcblxuICBmdW5jdGlvbiBSZXNvdXJjZUZhY3RvcnlGYWN0b3J5KCR3aW5kb3csXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYWxGb3JhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9jYWxSZXNvdXJjZUZhY3RvcnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hhaW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29sbGVjdGlvbikge1xuICAgICduZ0luamVjdCc7XG5cbiAgICBmdW5jdGlvbiBSZXNvdXJjZUZhY3RvcnkodXJsLCByb290S2V5LCByb290S2V5UGx1cmFsKSB7XG4gICAgICByb290S2V5UGx1cmFsID0gcm9vdEtleVBsdXJhbCB8fCAocm9vdEtleSArICdzJyk7XG5cbiAgICAgIC8vIENyZWF0ZSB0aGUgbG9jYWwgcmVzb3VyY2VcbiAgICAgIHZhciBMb2NhbFJlc291cmNlID0gTG9jYWxSZXNvdXJjZUZhY3RvcnkodXJsLCByb290S2V5LCByb290S2V5UGx1cmFsKTtcblxuICAgICAgLy8gSW4gbWVtb3J5IHJlc291cmNlIHN0b3JlXG4gICAgICB2YXIgX3Jlc291cmNlcyA9IHt9O1xuICAgICAgdmFyIF9yZXNGcm9tTG9jYWwgPSB7fTtcblxuICAgICAgLy8gQ3JlYXRlIGFuIGV2ZW50IGVtaXR0ZXJcbiAgICAgIHZhciBlbWl0dGVyID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcblxuICAgICAgLy8gTG9hZCBmcm9tIHBlcnNpc3RlbnQgc3RvcmFnZSAoaWYgd2UgaGF2ZSBzb21ldGhpbmcgbW9yZSBleGNpdGluZyB0aGFuIGxvY2Fsc3RvcmFnZSlcbiAgICAgIGlmICh1dGlscy5hZHZhbmNlZFN0b3JhZ2UoJGxvY2FsRm9yYWdlKSkge1xuICAgICAgICB2YXIgcFN0b3JhZ2VLZXkgPSB1dGlscy5wZXJzaXN0ZW50U3RvcmFnZUtleSh1cmwpO1xuICAgICAgICAkbG9jYWxGb3JhZ2UuZ2V0SXRlbShwU3RvcmFnZUtleSkudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgICAgICAgZGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdHVtKSB7XG4gICAgICAgICAgICB2YXIgb2JqID0gZGF0dW0ub2JqO1xuICAgICAgICAgICAgdmFyIGxhc3RSZXF1ZXN0ZWQgPSBkYXR1bS5sYXN0cmVxO1xuXG4gICAgICAgICAgICAvLyBPbmx5IGNyZWF0ZSBpZiB0aGUgdGltZSBiZXR3ZWVuIG5vdyBhbmQgdGhlIGxhc3QgcmVxdWVzdCBpcyBsZXNzIHRoYW5cbiAgICAgICAgICAgIC8vIHBTdG9yYWdlTWF4TGVuXG4gICAgICAgICAgICBpZiAoKG5vdyAtIGxhc3RSZXF1ZXN0ZWQpIDw9IHBTdG9yYWdlTWF4TGVuKSB7XG4gICAgICAgICAgICAgIGNyZWF0ZUZyb21TdG9yYWdlKG9iaiwgbGFzdFJlcXVlc3RlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBsb2NhbFRvUmVzKGxvYywgaWQpIHtcbiAgICAgICAgdmFyIHJlcyA9IF9yZXNGcm9tTG9jYWxbbG9jLiRpZF07XG5cbiAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBhIHJlc291cmNlIHRoZW4gY3JlYXRlIGl0XG4gICAgICAgIGlmICghcmVzKSB7XG4gICAgICAgICAgcmVzID0gbmV3IFJlc291cmNlKGxvYywgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICBfcmVzb3VyY2VzW2lkXSA9IHJlcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHRvT2JqZWN0KCkge1xuICAgICAgICByZXR1cm4gdXRpbHMudG9PYmplY3QodGhpcyk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHJlc2V0KCkge1xuXG4gICAgICAgIC8vIElmIHdlIGFyZW4ndCBzYXZlZCBhdCBhbGwgdGhlbiBqdXN0IHJlbW92ZVxuICAgICAgICBpZiAoIXRoaXMuJGNyZWF0ZWQpIHtcbiAgICAgICAgICB0aGlzLiRyZW1vdmUodHJ1ZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIG5ld1ZhbHVlcyA9IHRoaXMuJGxvYy4kdG9PYmplY3QoKTtcbiAgICAgICAgdXRpbHMucmVtb3ZlUmVzVmFsdWVzKHRoaXMpO1xuICAgICAgICB1dGlscy5zZXRSZXNWYWx1ZXModGhpcywgbmV3VmFsdWVzKTtcbiAgICAgIH1cblxuICAgICAgLy8gVGhlIHByb21pc2UgcmVzb2x2ZXMgb25jZSB0aGUgc2F2ZSBoYXMgYmVlbiBjb21taXR0ZWRcbiAgICAgIGZ1bmN0aW9uIHNhdmUoKSB7XG4gICAgICAgIHZhciByZXMgPSB0aGlzO1xuICAgICAgICByZXMuJGNyZWF0ZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gdGhpcy4kbG9jLiRzYXZlKHRoaXMuJHRvT2JqZWN0KCkpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKCFyZXMuJHJlc29sdmVkKSB7XG4gICAgICAgICAgICByZXMuJGRlZmVycmVkLnJlc29sdmUocmVzKTtcbiAgICAgICAgICAgIHJlcy4kcmVzb2x2ZWQgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgZnVuY3Rpb24gcmVtb3ZlKG5vUHJvbXB0LCBza2lwTG9jYWwpIHtcbiAgICAgICAgaWYoIW5vUHJvbXB0KSB7XG4gICAgICAgICAgLy8gQWRkIGNvbmZpcm1hdGlvbiBhbGVydFxuICAgICAgICAgIGlmKCEkd2luZG93LmNvbmZpcm0oJ0RvIHlvdSByZWFsbHkgd2FudCB0byBkZWxldGUgdGhpcyBpdGVtPycpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuJGRlbGV0ZWQgPSB0cnVlO1xuICAgICAgICBpZiAodGhpcy5faWQpIHtcbiAgICAgICAgICBkZWxldGUgX3Jlc291cmNlc1t0aGlzLl9pZF07XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgcHJvbTtcbiAgICAgICAgaWYgKHNraXBMb2NhbCkge1xuICAgICAgICAgIHByb20gPSAkcS53aGVuKHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByb20gPSB0aGlzLiRsb2MuJHJlbW92ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZW1pdHRlci5lbWl0KCdyZW1vdmUnLCB0aGlzKTtcblxuICAgICAgICByZXR1cm4gcHJvbTtcbiAgICAgIH1cblxuICAgICAgZnVuY3Rpb24gdHlwZSgpIHtcbiAgICAgICAgcmV0dXJuIHJvb3RLZXlbMF0udG9VcHBlckNhc2UoKSArIHJvb3RLZXkuc2xpY2UoMSk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGNvbGxlY3Rpb24oc2VlZHMsIHJlbGF0aW9uKSB7XG4gICAgICAgIHJldHVybiBDb2xsZWN0aW9uKFJlc291cmNlLCBzZWVkcywgcmVsYXRpb24pO1xuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBjaGFpbihvcmlnUXJ5LCBNb2RlbCwgcXJ5Rm4pIHtcbiAgICAgICAgcmV0dXJuIENoYWluKG9yaWdRcnksIE1vZGVsLCBxcnlGbik7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHF1ZXJ5KHFyeSwgbGltaXQpIHtcbiAgICAgICAgdmFyIHJlc3VsdCA9IExvY2FsUmVzb3VyY2UucXVlcnkocXJ5LCBsaW1pdCwgUmVzb3VyY2UpO1xuICAgICAgICBlbWl0dGVyLmVtaXQoJ3F1ZXJ5JywgcmVzdWx0LCBxcnksIGxpbWl0KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cblxuICAgICAgZnVuY3Rpb24gZ2V0KGlkcywgZm9yY2UpIHtcbiAgICAgICAgdmFyIHJlc3VsdHMgPSBMb2NhbFJlc291cmNlLmdldChpZHMsIGZvcmNlLCBsb2NhbFRvUmVzKTtcbiAgICAgICAgZW1pdHRlci5lbWl0KCdnZXQnLCBpZHMsIHJlc3VsdHMsIGZvcmNlKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHVwZGF0ZWRMb2NhbChyZXMsIG5ld1ZhbCwgb2xkVmFsKSB7XG5cbiAgICAgICAgLy8gV2UgY291bGQgaGF2ZSBiZWVuIGRlbGV0ZWQgKGV4aXN0aW5nIG9sZFZhbCwgbnVsbCBuZXd2YWwpXG4gICAgICAgIGlmIChvbGRWYWwgJiYgIW5ld1ZhbCkge1xuICAgICAgICAgIC8vIFdlIGhhdmUgYmVlbiBkZWxldGVkLiBDbGVhbnVwIG91cnNlbHZlc1xuICAgICAgICAgIHJlcy4kcmVtb3ZlKHRydWUsIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgcmVzLiRjcmVhdGVkID0gdHJ1ZTtcblxuICAgICAgICAgIGlmIChvbGRWYWwuX2lkICYmIChuZXdWYWwuX2lkICE9PSBvbGRWYWwuX2lkKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCB0byBjaGFuZ2UgaWQnKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBNZXJnZSB0aGUgb2JqZWN0cyB0b2dldGhlciB1c2luZyB0aGUgb2xkVmFsIGFzIGEgYmFzZSwgYW5kIHVzaW5nICpvdXIqIHZlcnNpb25cbiAgICAgICAgICAvLyB0byByZXNvbHZlIGFueSBjb25mbGljdHMuIFdlIG1heSBuZWVkIHRvIHB1dCBpbiBzb21lIGNvbmZsaWN0IHJlc29sdXRpb24gbG9naWNcbiAgICAgICAgICAvLyBzb21ld2hlcmUgb24gYSBjYXNlIGJ5IGNhc2UgYmFzaXNcbiAgICAgICAgICB2YXIgbWVyZ2UgPSB1dGlscy5tZXJnZU9iamVjdHMocmVzLiR0b09iamVjdCgpLCBvbGRWYWwsIG5ld1ZhbCk7XG5cbiAgICAgICAgICAvLyBOb3cgcHV0IGJhY2sgaW4gdGhlIG1lcmdlIHZhbHVlc1xuICAgICAgICAgIHV0aWxzLnJlbW92ZVJlc1ZhbHVlcyhyZXMpO1xuICAgICAgICAgIHV0aWxzLnNldFJlc1ZhbHVlcyhyZXMsIG1lcmdlKTtcblxuICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBhcmUgc3RvcmVkXG4gICAgICAgICAgX3Jlc291cmNlc1tyZXMuX2lkXSA9IHJlcztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiB1cGRhdGVTZXJ2ZXIodmFsKSB7XG4gICAgICAgIHRoaXMuJGxvYy4kdXBkYXRlU2VydmVyKHZhbCk7XG4gICAgICB9XG5cbiAgICAgIC8vIHVwZGF0ZXMgb3IgY3JlYXRlcyBhIG1vZGVsIGRlcGVuZGluZyBvbiB3aGV0aGVyIHdlIGtub3cgYWJvdXQgaXQgYWxyZWFkeS4gVGhpc1xuICAgICAgLy8gaXMgdXN1YWxseSB1c2VkIHdoZW4gd2UgcmVjaWV2ZSBhIHJlc3BvbnNlIHdpdGggbW9kZWwgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIgdXNpbmdcbiAgICAgIC8vIGEgbm9uLXN0YW5kYXJkIG1ldGhvZFxuICAgICAgZnVuY3Rpb24gdXBkYXRlT3JDcmVhdGUodmFsKSB7XG4gICAgICAgIHZhciByZXMgPSBfcmVzb3VyY2VzW3ZhbC5faWRdO1xuICAgICAgICBpZiAoIXJlcykge1xuICAgICAgICAgIHJlcyA9IG5ldyBSZXNvdXJjZSh2YWwsIGZhbHNlLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLiR1cGRhdGVTZXJ2ZXIodmFsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZyb21TdG9yYWdlKHZhbCwgbGFzdFJlcXVlc3RlZCkge1xuICAgICAgICB2YXIgcmVzID0gX3Jlc291cmNlc1t2YWwuX2lkXTtcblxuICAgICAgICAvLyBJZiB3ZSBkbyBoYXZlIGFscmVhZHkga25vdyBhYm91dCBhIHJlc291cmNlIHRoZW4gbGV0cyBhc3N1bWUgaXQgaXMgbW9yZSB1cCB0byBkYXRlXG4gICAgICAgIC8vIHRoYW4gdGhlIHN0b3JhZ2UgdmVyc2lvbi4gSWYgd2UgaGF2ZW4ndCByZXNvbHZlZCB5ZXQgdGhvdWdoIChvciB3ZSBkb24ndCB5ZXQgaGF2ZVxuICAgICAgICAvLyBhbiBJRCBvbiB0aGUgb2JqZWN0KSBsZXRzIHVwZGF0ZSBvdXIgdmFsdWVzXG4gICAgICAgIGlmICghcmVzKSB7XG4gICAgICAgICAgcmVzID0gbmV3IFJlc291cmNlKHZhbCwgZmFsc2UsIGxhc3RSZXF1ZXN0ZWQpO1xuICAgICAgICB9IGVsc2UgaWYgKCFyZXMuX2lkIHx8ICFyZXMuJHJlc29sdmVkKSB7XG4gICAgICAgICAgcmVzLiR1cGRhdGVTZXJ2ZXIodmFsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHJlZnJlc2goKSB7XG4gICAgICAgIHRoaXMuJGxvYy4kcmVmcmVzaCgpO1xuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBSZXNvdXJjZSh2YWwsIGZyb21Mb2MsIGxhc3RSZXF1ZXN0ZWQpIHtcbiAgICAgICAgdmFyIHJlcyA9IHRoaXM7XG4gICAgICAgIHRoaXMuJGRlbGV0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy4kZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuICAgICAgICB0aGlzLiRwcm9taXNlID0gdGhpcy4kZGVmZXJyZWQucHJvbWlzZTsgLy8gQW4gaW5pdGlhbCBwcm9taXNlIGZvciBvdXIgaW5pdGlhbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmV0Y2ggb3IgY3JlYXRlIG9mIGRhdGFcbiAgICAgICAgdGhpcy4kcmVzb2x2ZWQgPSBmYWxzZTsgLy8gSGF2ZSB3ZSBoYWQgYW4gaW5pdGlhbCByZXNvbHV0aW9uIG9mIHRoZSBwcm9taXNlXG4gICAgICAgIHRoaXMuJGNyZWF0ZWQgPSBmYWxzZTsgLy8gR29lcyB0cnVlIG9uIGFuIGluaXRpYWwgc2F2ZVxuXG4gICAgICAgIC8vIElmIHdlJ3ZlIGJlZW4gZ2l2ZW4gdmFsdWVzIHB1dCB0aGVtIG9uXG4gICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICB2YXIgcHJvcHMgPSBmcm9tTG9jID8gdmFsLiR0b09iamVjdCgpIDogdmFsO1xuICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykge1xuICAgICAgICAgICAgcmVzW2tleV0gPSBwcm9wc1trZXldO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgbG9jYWwgcmVzb3VyY2VcbiAgICAgICAgaWYgKGZyb21Mb2MpIHtcbiAgICAgICAgICB0aGlzLiRsb2MgPSB2YWw7XG4gICAgICAgICAgdGhpcy4kbG9jLiRtb2QgPSB0aGlzO1xuXG4gICAgICAgICAgLy8gUmVzb2x2ZSB0aGUgcHJvbWlzZSBvbmNlIHRoZSBsb2NhbCBjb3B5IGhhcyByZXNvbHZlZFxuICAgICAgICAgIHRoaXMuJGxvYy4kcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKCFyZXMuJHJlc29sdmVkKSB7XG4gICAgICAgICAgICAgIHJlcy4kZGVmZXJyZWQucmVzb2x2ZShyZXMpO1xuICAgICAgICAgICAgICByZXMuJHJlc29sdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9pZCkge1xuICAgICAgICAgIC8vIFdlIGhhdmUgYW4gaWQgLSBzbyB3ZSBwZXJzaXN0IGRvd25cbiAgICAgICAgICB0aGlzLiRsb2MgPSBuZXcgTG9jYWxSZXNvdXJjZSh2YWwsIGZhbHNlLCB0aGlzLCBsYXN0UmVxdWVzdGVkKTtcblxuICAgICAgICAgIC8vIFdlIGltbWVkaWF0ZWx5IHJlc29sdmUgb3VyIHByb21pc2Ugc2luY2Ugd2UgaGF2ZSBkYXRhXG4gICAgICAgICAgdGhpcy4kZGVmZXJyZWQucmVzb2x2ZSh0aGlzKTtcbiAgICAgICAgICB0aGlzLiRyZXNvbHZlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gRG9uJ3QgYWRkIGluIHRoZSB2YWx1ZXMgdW50aWwgd2Ugc2F2ZVxuICAgICAgICAgIHRoaXMuJGxvYyA9IG5ldyBMb2NhbFJlc291cmNlKG51bGwsIGZhbHNlLCB0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuJGlkID0gdGhpcy4kbG9jLiRpZDtcbiAgICAgICAgX3Jlc0Zyb21Mb2NhbFt0aGlzLiRpZF0gPSB0aGlzO1xuXG4gICAgICAgIC8vIElmIHdlIGhhdmUgYW4gaWQgdGhlbiBhZGQgdXMgdG8gdGhlIHN0b3JlXG4gICAgICAgIGlmICh0aGlzLl9pZCkge1xuICAgICAgICAgIF9yZXNvdXJjZXNbdGhpcy5faWRdID0gdGhpcztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlcyBvbiB0aGUgbG9jYWwgcmVzb3VyY2VcbiAgICAgICAgdGhpcy4kbG9jLiRlbWl0dGVyLm9uKCd1cGRhdGUnLCBmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCkge1xuICAgICAgICAgIHVwZGF0ZWRMb2NhbChyZXMsIG5ld1ZhbCwgb2xkVmFsKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH1cblxuICAgICAgUmVzb3VyY2UuZ2V0ID0gZ2V0O1xuICAgICAgUmVzb3VyY2UucXVlcnkgPSBxdWVyeTtcbiAgICAgIFJlc291cmNlLmNoYWluID0gY2hhaW47XG4gICAgICBSZXNvdXJjZS50eXBlID0gdHlwZTtcbiAgICAgIFJlc291cmNlLmNvbGxlY3QgPSBjb2xsZWN0aW9uO1xuICAgICAgUmVzb3VyY2UudXBkYXRlT3JDcmVhdGUgPSB1cGRhdGVPckNyZWF0ZTtcblxuICAgICAgLy8gRXZlbnQgZW1pdHRlciAnaW5oZXJpdGFuY2UnXG4gICAgICB2YXIgZWVwcm9wcyA9IFtcbiAgICAgICAgJ2FkZExpc3RlbmVyJyxcbiAgICAgICAgJ29uJyxcbiAgICAgICAgJ29uY2UnLFxuICAgICAgICAncmVtb3ZlTGlzdGVuZXInXG4gICAgICBdO1xuICAgICAgZWVwcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgICAgUmVzb3VyY2VbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4gZW1pdHRlcltwcm9wXS5hcHBseShlbWl0dGVyLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIFJlc291cmNlLnByb3RvdHlwZS4kc2F2ZSA9IHNhdmU7XG4gICAgICBSZXNvdXJjZS5wcm90b3R5cGUuJHJlbW92ZSA9IHJlbW92ZTtcbiAgICAgIFJlc291cmNlLnByb3RvdHlwZS4kZGVsZXRlID0gcmVtb3ZlO1xuICAgICAgUmVzb3VyY2UucHJvdG90eXBlLiR0eXBlID0gdHlwZTtcbiAgICAgIFJlc291cmNlLnByb3RvdHlwZS4kcmVzZXQgPSByZXNldDtcbiAgICAgIFJlc291cmNlLnByb3RvdHlwZS4kcmVmcmVzaCA9IHJlZnJlc2g7XG4gICAgICBSZXNvdXJjZS5wcm90b3R5cGUuJHRvT2JqZWN0ID0gdG9PYmplY3Q7XG4gICAgICBSZXNvdXJjZS5wcm90b3R5cGUuJHVwZGF0ZVNlcnZlciA9IHVwZGF0ZVNlcnZlcjtcblxuICAgICAgcmV0dXJuIFJlc291cmNlO1xuICAgIH1cblxuICAgIFJlc291cmNlRmFjdG9yeS5DaGFpbiA9IENoYWluO1xuXG4gICAgcmV0dXJuIFJlc291cmNlRmFjdG9yeTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
